<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
        }
        .box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #45a049;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 120px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        .highlight {
            background: linear-gradient(145deg, #ff0000, #fa2a06);
            color: #000;
            font-weight: bold;
        }
        .wishlist {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }
        .wish-item {
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .remove-wish {
            color: red;
            cursor: pointer;
        }
        .total-cost {
            background: #ff4081;
            color: white;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .history {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .got-wish {
            color: #ff0000;
            font-weight: bold;
            margin-top: 5px;
            padding-left: 10px;
            border-left: 3px solid #ff0000;
        }
        .prob-panel {
            position: sticky;
            top: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .prob-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .warn {
            background: #ffebee;
            color: #d32f2f;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="prob-panel">
            <h3>ğŸ“Š æ©Ÿç‡ç¸½è¦½</h3>
            <div id="probStats"></div>
            <div id="warn" class="warn"></div>
        </div>

        <div class="box">
            <h3>ğŸ“‹ ä½¿ç”¨èªªæ˜</h3>
            <ol>
                <li>è²¼ä¸Šå®˜æ–¹æ©Ÿç‡è¡¨ï¼ˆè‡ªå‹•è¨ˆç®—ç¸½æ©Ÿç‡ï¼‰</li>
                <li>è¨­å®šæ‰­è›‹åƒ¹æ ¼å’Œæ¬¡æ•¸</li>
                <li>åŠ å…¥æœŸæœ›é“å…·ï¼ˆå¯é¸ï¼‰</li>
                <li>é»æ“Šè¨ˆç®—æŸ¥çœ‹çµæœ</li>
            </ol>
        </div>
        
        <textarea id="input" placeholder="è«‹è²¼ä¸Šæ©Ÿç‡è¡¨..." oninput="analyzeProbability()"></textarea>
        
        <div class="box">
            <div>
                <label>å–®æŠ½åƒ¹æ ¼ï¼š</label>
                <input type="number" id="price" value="30" min="1">
            </div>
            <div style="margin-top:10px">
                <label>æŠ½å¡æ¬¡æ•¸ï¼š</label>
                <input type="number" id="times" value="10" min="1">
            </div>
            <div id="cost" style="margin-top:10px"></div>
        </div>

        <div class="box">
            <h3>æœŸæœ›é“å…·</h3>
            <div>
                <input type="text" id="wishInput" placeholder="è¼¸å…¥é“å…·åç¨±..." style="width:200px">
                <button onclick="addWishItem()" style="background:#2196f3">æ–°å¢</button>
            </div>
            <div id="wishlist" class="wishlist"></div>
        </div>

        <div class="box">
            <h3>ğŸ’° èŠ±è²»çµ±è¨ˆ</h3>
            <div class="total-cost" id="totalCost">
                ç´¯ç©èŠ±è²»ï¼šNT$ 0
                <div style="font-size: 0.8em" id="wishSummary"></div>
            </div>
            <div class="history" id="history"></div>
        </div>

        <button onclick="calculate()">è¨ˆç®—</button>
        <button onclick="clearAll()" style="background:#666">æ¸…é™¤</button>

        <div id="result"></div>
    </div>

<script>
    // å…¨å±€è®Šé‡
    let items = [];
    let wishItems = new Set();
    let expenses = [];
    let totalSpent = 0;
    let currentProbStats = null;

    // æ©Ÿç‡åˆ†æå‡½æ•¸
    function analyzeProbability() {
        const input = document.getElementById('input').value;
        const stats = {
            total: 0,
            grades: new Map(),
            items: 0,
            itemList: []
        };

        try {
            // è§£ææ©Ÿç‡è¡¨
            const sabcRegex = /([SABC])\s*ç­‰ç´š([^%]+?)(\d+\.\d+)%/g;
            let match;
            let hasMatch = false;

            // å˜—è©¦ SABC æ ¼å¼
            while ((match = sabcRegex.exec(input)) !== null) {
                hasMatch = true;
                const [, grade, name, prob] = match;
                const probability = parseFloat(prob);
                
                stats.total += probability;
                stats.items++;
                stats.grades.set(grade, (stats.grades.get(grade) || 0) + probability);
                stats.itemList.push({ grade, name: name.trim(), probability });
            }

            // å¦‚æœæ²’æœ‰ SABC æ ¼å¼ï¼Œå˜—è©¦ä¸€èˆ¬æ ¼å¼
            if (!hasMatch) {
                const regex = /(.+?)(\d+\.\d+)%/g;
                while ((match = regex.exec(input)) !== null) {
                    const [, name, prob] = match;
                    const probability = parseFloat(prob);
                    
                    stats.total += probability;
                    stats.items++;
                    stats.grades.set('ä¸€èˆ¬', (stats.grades.get('ä¸€èˆ¬') || 0) + probability);
                    stats.itemList.push({ grade: 'ä¸€èˆ¬', name: name.trim(), probability });
                }
            }

            currentProbStats = stats;
            updateProbabilityDisplay(stats);
            items = stats.itemList;
        } catch (error) {
            console.error('åˆ†æéŒ¯èª¤:', error);
        }
    }

    function updateProbabilityDisplay(stats) {
        if (stats.items === 0) {
            document.getElementById('probStats').innerHTML = '<div>ç­‰å¾…è¼¸å…¥æ©Ÿç‡è¡¨...</div>';
            document.getElementById('warn').style.display = 'none';
            return;
        }

        let html = `
            <div style="font-size:1.1em;margin-bottom:10px">
                ç¸½æ©Ÿç‡ï¼š<strong>${stats.total.toFixed(4)}%</strong>
                (å…± ${stats.items} å€‹é …ç›®)
            </div>
            <div class="prob-stats">
        `;

        stats.grades.forEach((prob, grade) => {
            html += `
                <div class="card">
                    ${grade}ç­‰ç´šï¼š${prob.toFixed(4)}%
                </div>
            `;
        });

        html += '</div>';
        document.getElementById('probStats').innerHTML = html;

        // æª¢æŸ¥ç¸½æ©Ÿç‡
        const warn = document.getElementById('warn');
        if (Math.abs(stats.total - 100) > 0.01) {
            warn.innerHTML = `âš ï¸ æ³¨æ„ï¼šç¸½æ©Ÿç‡ä¸ç­‰æ–¼100% (å·®ç•°ï¼š${(100 - stats.total).toFixed(4)}%)`;
            warn.style.display = 'block';
        } else {
            warn.style.display = 'none';
        }
    }

    // æœŸæœ›é“å…·ç›¸é—œ
    function addWishItem() {
        const input = document.getElementById('wishInput');
        const item = input.value.trim();
        if (item) {
            wishItems.add(item);
            input.value = '';
            updateWishlist();
            saveData();
        }
    }

    function removeWishItem(item) {
        wishItems.delete(item);
        updateWishlist();
        saveData();
    }

    function updateWishlist() {
        document.getElementById('wishlist').innerHTML = Array.from(wishItems)
            .map(item => `
                <div class="wish-item">
                    ${item}
                    <span class="remove-wish" onclick="removeWishItem('${item}')">&times;</span>
                </div>
            `).join('');
    }

    // èŠ±è²»è¨˜éŒ„ç›¸é—œ
    function addExpense(amount, pulls, results) {
        const gotWishes = Array.from(results.entries())
            .filter(([name]) => wishItems.has(name))
            .map(([name, count]) => `${name} (${count}æ¬¡)`);

        expenses.push({
            amount,
            pulls,
            date: new Date().toLocaleString(),
            gotWishes
        });

        totalSpent += amount;
        updateExpenseDisplay();
        saveData();
    }

    function updateExpenseDisplay() {
        const totalWishHits = expenses.reduce((sum, exp) => 
            sum + exp.gotWishes.length, 0);

        document.getElementById('totalCost').innerHTML = `
            ç´¯ç©èŠ±è²»ï¼šNT$ ${totalSpent.toLocaleString()}
            <div style="font-size:0.8em">
                æœŸæœ›é“å…·ç¸½è¨ˆç²å¾—ï¼š${totalWishHits} å€‹
            </div>
        `;
        
        document.getElementById('history').innerHTML = expenses.map((exp, index) => `
            <div class="history-item">
                <div style="display:flex;justify-content:space-between">
                    <div>
                        <strong>NT$ ${exp.amount.toLocaleString()}</strong> 
                        (${exp.pulls}æŠ½)
                        <div style="color:#666;font-size:0.9em">${exp.date}</div>
                    </div>
                    <button class="delete-btn" onclick="removeExpense(${index})">åˆªé™¤</button>
                </div>
                ${exp.gotWishes.length > 0 ? `
                    <div class="got-wish">
                        âœ¨ æŠ½ä¸­ï¼š${exp.gotWishes.join(', ')}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    // æ ¸å¿ƒè¨ˆç®—åŠŸèƒ½
    function calculate() {
        if (!currentProbStats || currentProbStats.items === 0) {
            alert('è«‹å…ˆè²¼å…¥æ©Ÿç‡è¡¨');
            return;
        }

        const price = +document.getElementById('price').value;
        const times = +document.getElementById('times').value;
        
        try {
            const pulls = new Map();
            const gradeStats = new Map();
            const total = currentProbStats.total;

            // æ¨¡æ“¬æŠ½å¡
            for (let i = 0; i < times; i++) {
                let rand = Math.random() * total;
                let sum = 0;
                for (const item of items) {
                    sum += item.probability;
                    if (rand <= sum) {
                        pulls.set(item.name, (pulls.get(item.name) || 0) + 1);
                        gradeStats.set(item.grade, (gradeStats.get(item.grade) || 0) + 1);
                        break;
                    }
                }
            }

            // æ·»åŠ èŠ±è²»è¨˜éŒ„
            addExpense(price * times, times, pulls);

            // ç”Ÿæˆçµæœ
            const wishResults = Array.from(pulls.entries())
                .filter(([name]) => wishItems.has(name));

            let html = `
                <div class="box">
                    <h3>æ¨¡æ“¬çµæœ</h3>
                    <p>ç¸½æ©Ÿç‡ï¼š${total.toFixed(2)}%</p>
                    <p>æœ¬æ¬¡èŠ±è²»ï¼šNT$ ${(price * times).toLocaleString()}</p>
                    <p>æŠ½å¡æ¬¡æ•¸ï¼š${times} æ¬¡</p>
                    ${wishResults.length > 0 ? `
                        <div class="success-rate">
                            æœ¬æ¬¡æŠ½ä¸­æœŸæœ›é“å…·ï¼š<br>
                            ${wishResults.map(([name, count]) => 
                                `${name}: ${count}æ¬¡ (${(count/times*100).toFixed(1)}%)`
                            ).join('<br>')}
                        </div>
                    ` : ''}
                    <h4>çå“çµ±è¨ˆ</h4>
                    <div class="grid">
                        ${Array.from(pulls).map(([name, count]) => `
                            <div class="card ${wishItems.has(name) ? 'highlight' : ''}">
                                ${name}<br>
                                ${count}æ¬¡ (${(count/times*100).toFixed(1)}%)
                            </div>
                        `).join('')}
                    </div>
                    <h4>ç­‰ç´šçµ±è¨ˆ</h4>
                    <div class="grid">
                        ${Array.from(gradeStats).map(([grade, count]) => `
                            <div class="card">
                                ${grade}<br>
                                ${count}æ¬¡ (${(count/times*100).toFixed(1)}%)
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('result').innerHTML = html;

        } catch (error) {
            document.getElementById('result').innerHTML = 
                `<div class="box" style="border-left-color:red">éŒ¯èª¤ï¼š${error.message}</div>`;
        }
    }

    // å·¥å…·å‡½æ•¸
    function removeExpense(index) {
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
            totalSpent -= expenses[index].amount;
            expenses.splice(index, 1);
            updateExpenseDisplay();
            saveData();
        }
    }

    function updateCost() {
        const price = +document.getElementById('price').value || 0;
        const times = +document.getElementById('times').value || 0;
        document.getElementById('cost').textContent = 
            `æœ¬æ¬¡èŠ±è²»ï¼šNT$ ${(price * times).toLocaleString()}`;
    }

    function saveData() {
        localStorage.setItem('gachaData', JSON.stringify({
            expenses,
            wishItems: [...wishItems],
            totalSpent
        }));
    }

    function loadData() {
        const saved = localStorage.getItem('gachaData');
        if (saved) {
            const data = JSON.parse(saved);
            expenses = data.expenses;
            wishItems = new Set(data.wishItems);
            totalSpent = data.totalSpent;
            updateExpenseDisplay();
            updateWishlist();
        }
    }

    function clearAll() {
        if (confirm('æ˜¯å¦æ¸…é™¤æ‰€æœ‰è¨˜éŒ„ï¼Ÿ')) {
            expenses = [];
            totalSpent = 0;
            wishItems.clear();
            currentProbStats = null;
            localStorage.removeItem('gachaData');
            document.getElementById('input').value = '';
            document.getElementById('price').value = '30';
            document.getElementById('times').value = '10';
            document.getElementById('result').innerHTML = '';
            document.getElementById('probStats').innerHTML = '<div>ç­‰å¾…è¼¸å…¥æ©Ÿç‡è¡¨...</div>';
            document.getElementById('warn').style.display = 'none';
            updateExpenseDisplay();
            updateWishlist();
            updateCost();
            items = [];
        }
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('price').addEventListener('input', updateCost);
    document.getElementById('times').addEventListener('input', updateCost);
    document.getElementById('wishInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') addWishItem();
    });
    document.getElementById('input').addEventListener('paste', () => {
        setTimeout(() => {
            analyzeProbability();
            calculate();
        }, 100);
    });

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
        loadData();
        updateCost();
    });
</script>
</body>
</html>